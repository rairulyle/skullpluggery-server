# ğŸ’€ SKULLSERVER Docker Compose Stacks

Docker Compose stacks for SKULLSERVER, managed by Unraid Compose Manager.

## ğŸ“ Directory Structure

```
stacks/
â”œâ”€â”€ .env                         # ğŸŒ Global variables (edit this)
â”œâ”€â”€ .env.example                 # Global variables template
â”œâ”€â”€ media/                       # ğŸ¬ Media services
â”‚   â”œâ”€â”€ docker-compose.yml
â”‚   â”œâ”€â”€ .env                     # âš™ï¸ Auto-generated (do not edit)
â”‚   â”œâ”€â”€ .env.example             # Stack variables template
â”‚   â””â”€â”€ .env.local               # ğŸ”§ Stack variables (edit this)
â”œâ”€â”€ network/                     # ğŸŒ Network services
â”‚   â””â”€â”€ ...
â””â”€â”€ utilities/                   # ğŸ› ï¸ Utility services
    â””â”€â”€ ...
```

## ğŸ“¦ Stack Overview

| Stack            | Description                              |
| ---------------- | ---------------------------------------- |
| ğŸ¬ **media**     | Media server and content acquisition     |
| ğŸŒ **network**   | Network infrastructure and reverse proxy |
| ğŸ› ï¸ **utilities** | Dashboard and monitoring tools           |

## âš™ï¸ Stack Management

### ğŸ›ï¸ Unraid Compose Manager (Recommended)

All stacks are managed through the Unraid Compose Manager UI:

1. Navigate to **Docker** â†’ **Compose Manager**
2. Select your stack
3. Use UI buttons to start/stop, update, view logs, or edit

`/boot/config/plugins/compose.manager/compose.manager.cfg`

```yaml
PROJECTS_FOLDER="/mnt/user/git/skullserver/stacks"
```

### ğŸ”‘ Naming Convention (Important)

For Compose Manager to recognize existing stacks, these **must** match:

- âœ… Folder name: `media`
- âœ… File name: `docker-compose.yml` (not `compose.yml`)
- âœ… Project name: `name: media` (at top of compose file)

Otherwise, duplicate folders like `media181998424` will be created.

### ğŸ’» Docker Compose CLI (Alternative)

```bash
# Navigate to stack
cd /mnt/user/git/skullserver/stacks/media

# Start
docker compose up -d

# Update
docker compose pull && docker compose up -d

# Logs
docker compose logs -f [service_name]

# Stop
docker compose down
```

## ğŸ” Environment Variables

### ğŸ“Š System Overview

```
Global Variables (stacks/.env)
    â†“
    â”œâ”€â†’ Stack Variables (stacks/media/.env.local)
    â”œâ”€â†’ Stack Variables (stacks/network/.env.local)
    â””â”€â†’ Stack Variables (stacks/utilities/.env.local)
           â†“
    Auto-Generated (stacks/[stack]/.env) â† Used by Docker Compose
```

### ğŸŒ Global Variables

**Location**: `stacks/.env`

Shared across all stacks. Retrieve from **Bitwarden â†’ `SKULLSERVER Global Env`**

Common variables: `TZ`, `IP_ADDRESS`, `DOMAIN_NAME`, `APP_DATA`, `DATA`, etc.

### ğŸ”§ Stack-Specific Variables

**Location**: `stacks/<stack>/.env.local`

Unique to each stack. Retrieve from **Bitwarden â†’ `SKULLSERVER <stack> Env`**

Example for media stack: `PLEX_API_KEY`, `RADARR_API_KEY`, `SONARR_API_KEY`, etc.

### âš™ï¸ Auto-Generated Files

**Location**: `stacks/<stack>/.env`

**âš ï¸ DO NOT EDIT** - Auto-generated by `npm run sync-env`

Contains merged global + stack-specific variables used by Docker Compose.

## ğŸ”„ Syncing Environment Variables

### Usage

```bash
npm run sync-env
```

### ğŸ“ Workflow

1. **Edit Global** â†’ `stacks/.env` (from Bitwarden)
2. **Edit Stack** â†’ `stacks/<stack>/.env.local` (from Bitwarden)
3. **Sync** â†’ `npm run sync-env`
4. **Deploy** â†’ Restart stack in Compose Manager

### â• Adding New Variables

**Global Variables:**

1. Add to Bitwarden â†’ `SKULLSERVER Global Env`
2. Add to `stacks/.env`
3. Add template to `stacks/.env.example`
4. Run `npm run sync-env`

**Stack-Specific Variables:**

1. Add to Bitwarden â†’ `SKULLSERVER <stack> Env`
2. Add to `stacks/<stack>/.env.local`
3. Add template to `stacks/<stack>/.env.example`
4. Run `npm run sync-env`

## ğŸ†• Creating a New Stack

1. Create directory: `mkdir stacks/newstack`
2. Create `docker-compose.yml`:

   ```yaml
   name: newstack # Must match folder name

   services:
     myservice:
       container_name: myservice
       # ...
   ```

3. Create `.env.local` and `.env.example`
4. Run `npm run sync-env`
5. Import in Compose Manager UI

## ğŸ› Troubleshooting

### âŒ Duplicate Folders Created

**Problem**: Compose Manager creates `media181998424` instead of using `media`

**Solution**: Ensure these match:

- âœ… Folder name: `media`
- âœ… File name: `docker-compose.yml` (not `compose.yml`)
- âœ… Project name: `name: media`

### âŒ Environment Variables Not Working

**Problem**: Services fail to start or can't find configuration

**Solution**:

1. Check `stacks/.env` exists
2. Check `stacks/<stack>/.env.local` has variables
3. Run `npm run sync-env`
4. Restart stack in Compose Manager

### âŒ Stack Not Detected

**Check**:

- File named `docker-compose.yml` (not `compose.yml`)
- File in `/mnt/user/git/skullserver/stacks/<stack>/`
- `name:` field at top of compose file

## ğŸ“‹ Best Practices

- âœ… **Never edit** `<stack>/.env` (auto-generated)
- âœ… **Always run** `npm run sync-env` after changing env variables
- âœ… **Follow conventions** in [CONVENTIONS.md](./CONVENTIONS.md)
- âœ… **Use** `docker-compose.yml` (not `compose.yml`)
- âœ… **Set** `name:` field matching folder name
- âœ… **Keep secrets** in Bitwarden

## ğŸ“š Related Documentation

- ğŸ“– [CONVENTIONS.md](./CONVENTIONS.md) - Docker Compose coding standards
- âš™ï¸ `/boot/config/plugins/compose.manager/compose.manager.cfg` - Compose Manager config
